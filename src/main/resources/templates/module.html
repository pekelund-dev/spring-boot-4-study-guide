<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${module.title} + ' | Spring Scholar'">Module</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
<div class="min-h-screen">
    <header class="border-b border-slate-800 bg-slate-900/80">
        <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-6">
            <div>
                <p class="text-xs uppercase tracking-[0.25em] text-emerald-400">Module</p>
                <h1 class="text-2xl font-semibold" th:text="${module.title}">Module</h1>
                <p class="mt-1 text-sm text-slate-300" th:text="${module.description}">Description</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="/" class="rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold">Back</a>
                <a th:if="${!isAuthenticated}" href="/login" class="rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-slate-950">Log in</a>
                <form th:if="${isAuthenticated}" method="post" action="/logout">
                    <button class="rounded-full bg-white/10 px-4 py-2 text-xs font-semibold">Log out</button>
                </form>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-6xl px-6 py-10">
        <div class="grid gap-6">
            <div th:each="section : ${module.sections}" th:attr="id=${section.id}" class="rounded-2xl border border-slate-800 bg-slate-900/70 p-6">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                        <p class="text-xs uppercase tracking-[0.2em] text-emerald-400" th:text="${section.type}">TEXT</p>
                        <h2 class="text-xl font-semibold" th:text="${section.title}">Section title</h2>
                    </div>
                    <div class="flex items-center gap-2" th:if="${isAuthenticated}">
                        <form method="post" action="/progress/complete">
                            <input type="hidden" name="moduleId" th:value="${module.id}" />
                            <input type="hidden" name="sectionId" th:value="${section.id}" />
                            <button type="submit" class="rounded-full border border-emerald-500 px-3 py-1 text-xs" th:text="${completed[section.id]} ? 'Completed' : 'Mark complete'"></button>
                        </form>
                        <form method="post" action="/progress/pin">
                            <input type="hidden" name="moduleId" th:value="${module.id}" />
                            <input type="hidden" name="sectionId" th:value="${section.id}" />
                            <button type="submit" class="rounded-full border border-slate-600 px-3 py-1 text-xs" th:text="${pinned[section.id]} ? 'Pinned' : 'Pin'"></button>
                        </form>
                    </div>
                </div>

                <div class="mt-4 space-y-4">
                    <p th:if="${section.body}" class="text-sm leading-relaxed text-slate-200" th:text="${section.body}">Text</p>

                    <div th:if="${section.diagram}" class="rounded-xl bg-slate-950 p-4">
                        <pre class="mermaid" th:text="${section.diagram}"></pre>
                    </div>

                    <div th:if="${section.code}" class="rounded-xl bg-slate-950 p-4">
                        <p class="text-xs uppercase text-emerald-400">Code Example</p>
                        <pre class="mt-2 overflow-x-auto text-xs text-emerald-100" th:text="${section.code}"></pre>
                    </div>

                    <div th:if="${section.commands}" class="rounded-xl border border-slate-700 bg-slate-950/70 p-4">
                        <p class="text-xs uppercase text-emerald-400">Useful Commands</p>
                        <ul class="mt-2 space-y-2 text-xs text-slate-200">
                            <li th:each="command : ${section.commands}" class="rounded-lg bg-slate-900/70 px-3 py-2" th:text="${command}"></li>
                        </ul>
                    </div>

                    <div th:if="${section.exercisePrompt}" class="rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-4">
                        <p class="text-xs uppercase text-emerald-300">Coding Exercise</p>
                        <p class="mt-2 text-sm" th:text="${section.exercisePrompt}"></p>
                        <div class="mt-3">
                            <p class="text-xs uppercase text-emerald-300">Starter</p>
                            <pre class="mt-2 overflow-x-auto text-xs" th:text="${section.exerciseStarter}"></pre>
                        </div>
                        <details class="mt-3">
                            <summary class="cursor-pointer text-xs uppercase text-emerald-200">Reveal solution</summary>
                            <pre class="mt-2 overflow-x-auto text-xs" th:text="${section.exerciseSolution}"></pre>
                        </details>
                    </div>

                    <div th:if="${section.questions}" class="rounded-xl border border-slate-700 bg-slate-950/70 p-4">
                        <p class="text-xs uppercase text-emerald-400" th:text="${section.type == 'EXAM' ? 'Exam' : 'Quiz'}">Quiz</p>
                        <form method="post" action="/quiz/submit" class="mt-3 space-y-4">
                            <input type="hidden" name="moduleId" th:value="${module.id}" />
                            <input type="hidden" name="sectionId" th:value="${section.id}" />
                            <div th:each="question,iter : ${section.questions}">
                                <p class="text-sm font-medium" th:text="${question.prompt}"></p>
                                <div class="mt-2 space-y-2">
                                    <label th:each="option,opIndex : ${question.options}" class="flex items-center gap-2 text-sm">
                                        <input type="radio" th:name="${'q_' + iter.index}" th:value="${opIndex.index}" required />
                                        <span th:text="${option}"></span>
                                    </label>
                                </div>
                            </div>
                            <button class="rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-slate-950">Submit</button>
                            <p th:if="${scores[section.id]}" class="text-xs text-emerald-200">Saved score: <span th:text="${scores[section.id]}"></span> / <span th:text="${#lists.size(section.questions)}"></span></p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<script>
    mermaid.initialize({ startOnLoad: true, theme: 'dark' });
</script>
</body>
</html>
